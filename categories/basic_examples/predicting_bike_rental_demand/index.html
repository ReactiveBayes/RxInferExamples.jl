<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Predicting Bike Rental Demand ¬∑ RxInfer.jl Examples</title><meta name="title" content="Predicting Bike Rental Demand ¬∑ RxInfer.jl Examples"/><meta property="og:title" content="Predicting Bike Rental Demand ¬∑ RxInfer.jl Examples"/><meta property="twitter:title" content="Predicting Bike Rental Demand ¬∑ RxInfer.jl Examples"/><meta name="description" content="A repository of examples and tutorials for RxInfer.jl, a Julia package for reactive message passing inference in probabilistic models."/><meta property="og:description" content="A repository of examples and tutorials for RxInfer.jl, a Julia package for reactive message passing inference in probabilistic models."/><meta property="twitter:description" content="A repository of examples and tutorials for RxInfer.jl, a Julia package for reactive message passing inference in probabilistic models."/><meta property="og:url" content="https://examples.rxinfer.ml/categories/basic_examples/predicting_bike_rental_demand/"/><meta property="twitter:url" content="https://examples.rxinfer.ml/categories/basic_examples/predicting_bike_rental_demand/"/><link rel="canonical" href="https://examples.rxinfer.ml/categories/basic_examples/predicting_bike_rental_demand/"/><script async src="https://www.googletagmanager.com/gtag/js?id=G-GMFX620VEP"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GMFX620VEP', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script><link href="../../../assets/theme.css" rel="stylesheet" type="text/css"/><link href="../../../assets/header.css" rel="stylesheet" type="text/css"/><script src="../../../assets/header.js"></script><script src="../../../assets/chat.js"></script><link href="../../../assets/favicon.ico" rel="icon" type="image/x-icon"/>
    <meta property="og:title" content="Predicting Bike Rental Demand - RxInfer Examples">
    <meta name="description" content="An illustrative guide to implementing prediction mechanisms within RxInfer.jl, using bike rental demand forecasting as a contextual example.
">
    <meta property="og:description" content="An illustrative guide to implementing prediction mechanisms within RxInfer.jl, using bike rental demand forecasting as a contextual example.
">
    <meta name="keywords" content="rxinfer, julia, bayesian inference, examples, probabilistic programming, message passing, probabilistic numerics, variational inference, belief propagation, basic examples, prediction, time series, real data">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="https://examples.rxinfer.ml/sitemap.xml">
    </head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img class="docs-light-only" src="../../../assets/logo.svg" alt="RxInfer.jl Examples logo"/><img class="docs-dark-only" src="../../../assets/logo-dark.svg" alt="RxInfer.jl Examples logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">RxInfer.jl Examples</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../../how_to_contribute/">How to contribute</a></li><li><a class="tocitem" href="../../../autogenerated/list_of_examples/">List of Examples</a></li><li><span class="tocitem">Basic Examples</span><ul><li><a class="tocitem" href="../bayesian_binomial_regression/">Bayesian Binomial Regression</a></li><li><a class="tocitem" href="../bayesian_linear_regression/">Bayesian Linear Regression</a></li><li><a class="tocitem" href="../bayesian_multinomial_regression/">Bayesian Multinomial Regression</a></li><li><a class="tocitem" href="../coin_toss_model/">Coin Toss Model</a></li><li><a class="tocitem" href="../feature_functions_in_bayesian_regression/">Feature Functions In Bayesian Regression</a></li><li><a class="tocitem" href="../hidden_markov_model/">Hidden Markov Model</a></li><li><a class="tocitem" href="../kalman_filtering_and_smoothing/">Kalman Filtering And Smoothing</a></li><li><a class="tocitem" href="../pomdp_control/">Pomdp Control</a></li><li class="is-active"><a class="tocitem" href>Predicting Bike Rental Demand</a><ul class="internal"><li><a class="tocitem" href="#Preamble:-Enabling-Predictions"><span>Preamble: Enabling Predictions</span></a></li><li><a class="tocitem" href="#Objective"><span>Objective</span></a></li><li><a class="tocitem" href="#Dataset-Source"><span>Dataset Source</span></a></li><li><a class="tocitem" href="#Generative-Model-with-Priors"><span>Generative Model with Priors</span></a></li><li><a class="tocitem" href="#Improving-the-model"><span>Improving the model</span></a></li></ul></li></ul></li><li><span class="tocitem">Advanced Examples</span><ul><li><a class="tocitem" href="../../advanced_examples/active_inference_mountain_car/">Active Inference Mountain Car</a></li><li><a class="tocitem" href="../../advanced_examples/advanced_tutorial/">Advanced Tutorial</a></li><li><a class="tocitem" href="../../advanced_examples/assessing_people_skills/">Assessing People Skills</a></li><li><a class="tocitem" href="../../advanced_examples/chance_constraints/">Chance Constraints</a></li><li><a class="tocitem" href="../../advanced_examples/conjugate-computational_variational_message_passing/">Conjugate-Computational Variational Message Passing</a></li><li><a class="tocitem" href="../../advanced_examples/drone_dynamics/">Drone Dynamics</a></li><li><a class="tocitem" href="../../advanced_examples/global_parameter_optimisation/">Global Parameter Optimisation</a></li><li><a class="tocitem" href="../../advanced_examples/gp_regression_by_ssm/">Gp Regression By Ssm</a></li><li><a class="tocitem" href="../../advanced_examples/infinite_data_stream/">Infinite Data Stream</a></li><li><a class="tocitem" href="../../advanced_examples/multi-agent_trajectory_planning/">Multi-Agent Trajectory Planning</a></li><li><a class="tocitem" href="../../advanced_examples/nonlinear_sensor_fusion/">Nonlinear Sensor Fusion</a></li><li><a class="tocitem" href="../../advanced_examples/robotic_arm/">Robotic Arm</a></li></ul></li><li><span class="tocitem">Problem Specific</span><ul><li><a class="tocitem" href="../../problem_specific/autoregressive_models/">Autoregressive Models</a></li><li><a class="tocitem" href="../../problem_specific/gamma_mixture/">Gamma Mixture</a></li><li><a class="tocitem" href="../../problem_specific/gaussian_mixture/">Gaussian Mixture</a></li><li><a class="tocitem" href="../../problem_specific/hierarchical_gaussian_filter/">Hierarchical Gaussian Filter</a></li><li><a class="tocitem" href="../../problem_specific/invertible_neural_network_tutorial/">Invertible Neural Network Tutorial</a></li><li><a class="tocitem" href="../../problem_specific/litter_model/">Litter Model</a></li><li><a class="tocitem" href="../../problem_specific/ode_parameter_estimation/">Ode Parameter Estimation</a></li><li><a class="tocitem" href="../../problem_specific/probit_model/">Probit Model</a></li><li><a class="tocitem" href="../../problem_specific/rts_vs_bifm_smoothing/">Rts Vs Bifm Smoothing</a></li><li><a class="tocitem" href="../../problem_specific/simple_nonlinear_node/">Simple Nonlinear Node</a></li><li><a class="tocitem" href="../../problem_specific/structural_dynamics_with_augmented_kalman_filter/">Structural Dynamics With Augmented Kalman Filter</a></li><li><a class="tocitem" href="../../problem_specific/universal_mixtures/">Universal Mixtures</a></li></ul></li><li><a class="tocitem" href="../../../how_build_works/">How we build the examples</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basic Examples</a></li><li class="is-active"><a href>Predicting Bike Rental Demand</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Predicting Bike Rental Demand</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ReactiveBayes/RxInferExamples.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/ReactiveBayes/RxInferExamples.jl/blob/main/docs/src/categories/basic_examples/predicting_bike_rental_demand/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><div class="admonition is-info"><header class="admonition-header">Contributing</header><div class="admonition-body"><p>This example was automatically generated from a Jupyter notebook in the <a href="https://github.com/ReactiveBayes/RxInferExamples.jl">RxInferExamples.jl</a> repository.</p><p>We welcome and encourage contributions! You can help by:</p><ul><li>Improving this example</li><li>Creating new examples </li><li>Reporting issues or bugs</li><li>Suggesting enhancements</li></ul><p>Visit our <a href="https://github.com/ReactiveBayes/RxInferExamples.jl">GitHub repository</a> to get started. Together we can make <a href="https://github.com/ReactiveBayes/RxInfer.jl">RxInfer.jl</a> even better! üí™</p></div></div><hr/><h1 id="Predicting-Bike-Rental-Demand"><a class="docs-heading-anchor" href="#Predicting-Bike-Rental-Demand">Predicting Bike Rental Demand</a><a id="Predicting-Bike-Rental-Demand-1"></a><a class="docs-heading-anchor-permalink" href="#Predicting-Bike-Rental-Demand" title="Permalink"></a></h1><p><strong>Important Note</strong>: This notebook primarily aims to show how to manage missing data and generate predictions using a model. It does not serve as a comprehensive guide to building the most advanced model for this dataset or showcase the best practices in feature engineering. To keep explanations clear, we will use simplified assumptions and straightforward models. For applications in the real world, you should employ more sophisticated approaches and feature engineering methods. However, we will present a more complex model towards the end of this notebook for you to explore, albeit with less detailed guidance.</p><pre><code class="language-julia hljs">using RxInfer</code></pre><h2 id="Preamble:-Enabling-Predictions"><a class="docs-heading-anchor" href="#Preamble:-Enabling-Predictions">Preamble: Enabling Predictions</a><a id="Preamble:-Enabling-Predictions-1"></a><a class="docs-heading-anchor-permalink" href="#Preamble:-Enabling-Predictions" title="Permalink"></a></h2><p><code>RxInfer.jl</code> facilitates predictions in two primary ways. </p><ol><li><strong>Implicit Prediction</strong>: By adding <code>missing</code> instances directly into the data, which are then treated as regular observations during inference.</li><li><strong>Explicit Prediction</strong>: By defining a separate data variable in the model. This approach doesn&#39;t necessitate passing <code>missing</code> instances as the data variable but does require specifying the <code>predictvar</code> argument in the inference function.</li></ol><h3 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h3><p>Consider the following model:</p><pre><code class="language-julia hljs">@model function example_model(y)

    h ~ NormalMeanPrecision(0, 1.0)
    x ~ NormalMeanPrecision(h, 1.0)
    y ~ NormalMeanPrecision(x, 10.0)
end</code></pre><pre><code class="language-julia hljs"># Implicit Prediction
result = infer(model = example_model(), data = (y = missing,))</code></pre><pre><code class="nohighlight hljs">Inference results:
  Posteriors       | available for (h, x)
  Predictions      | available for (y)</code></pre><pre><code class="language-julia hljs"># Explicit Prediction
result = infer(model = example_model(), predictvars = (y = KeepLast(),))</code></pre><pre><code class="nohighlight hljs">Inference results:
  Posteriors       | available for (h, x)
  Predictions      | available for (y)</code></pre><p>Both approaches yield the same results, but the choice depends on personal preferences and the model&#39;s structure. In scenarios with a clear distinction between observed and predicted variables, the explicit method is preferable. However, our subsequent example will not differentiate between observations and predictions, as it utilizes a state space representation.</p><pre><code class="language-julia hljs">using CSV, DataFrames, Plots</code></pre><h2 id="Objective"><a class="docs-heading-anchor" href="#Objective">Objective</a><a id="Objective-1"></a><a class="docs-heading-anchor-permalink" href="#Objective" title="Permalink"></a></h2><p>This example aims to simultaneously learn the dynamics of the feature space and predict hourly bike rental demand through reactive message passing, a signature approach of <code>RxInfer.jl</code>.</p><h2 id="Dataset-Source"><a class="docs-heading-anchor" href="#Dataset-Source">Dataset Source</a><a id="Dataset-Source-1"></a><a class="docs-heading-anchor-permalink" href="#Dataset-Source" title="Permalink"></a></h2><p>Data for this example study is sourced from the Kaggle <a href="https://www.kaggle.com/datasets/brajeshmohapatra/bike-count-prediction-data-set">Bike Count Prediction Dataset</a>. For the purpose of this example, the original dataset from Kaggle has been adapted by removing categorical variables such as season, holiday, and working day. Additionally we take only 500 entries. This modification allows us to focus on modeling the continuous variables without additional complexities of handling categorical data. Nevertheless, this extension is feasible within <code>RxInfer.jl</code>.</p><pre><code class="language-julia hljs"># Load the data
df = CSV.read(&quot;modified_bicycle.csv&quot;, DataFrame)
df[1:10, :]</code></pre><pre><code class="nohighlight hljs">10√ó6 DataFrame
 Row ‚îÇ datetime            temp     atemp    humidity  windspeed  count
     ‚îÇ String31            Float64  Float64  Float64   Float64    Int64
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   1 ‚îÇ 2011-01-01 0:00:00     9.84   14.395      81.0     0.0        16
   2 ‚îÇ 2011-01-01 1:00:00     9.02   13.635      80.0     0.0        40
   3 ‚îÇ 2011-01-01 2:00:00     9.02   13.635      80.0     0.0        32
   4 ‚îÇ 2011-01-01 3:00:00     9.84   14.395      75.0     0.0        13
   5 ‚îÇ 2011-01-01 4:00:00     9.84   14.395      75.0     0.0         1
   6 ‚îÇ 2011-01-01 5:00:00     9.84   12.88       75.0     6.0032      1
   7 ‚îÇ 2011-01-01 6:00:00     9.02   13.635      80.0     0.0         2
   8 ‚îÇ 2011-01-01 7:00:00     8.2    12.88       86.0     0.0         3
   9 ‚îÇ 2011-01-01 8:00:00     9.84   14.395      75.0     0.0         8
  10 ‚îÇ 2011-01-01 9:00:00    13.12   17.425      76.0     0.0        14</code></pre><pre><code class="language-julia hljs"># we reserve few samples for prediction
n_future = 24

# `x` is a sequence of observed features
X = Union{Vector{Float64}, Missing}[[row[i] for i in 2:(ncol(df))-1] for row in eachrow(df)][1:end-n_future]

# `y` is a sequence of &quot;count&quot; bicycles
y = Union{Float64, Missing}[df[:, &quot;count&quot;]...][1:end-n_future]

state_dim = length(X[1]); # dimensionality of feature space</code></pre><h2 id="Generative-Model-with-Priors"><a class="docs-heading-anchor" href="#Generative-Model-with-Priors">Generative Model with Priors</a><a id="Generative-Model-with-Priors-1"></a><a class="docs-heading-anchor-permalink" href="#Generative-Model-with-Priors" title="Permalink"></a></h2><p>We present a generative model that delineates the latent dynamics of feature evolution, represented by <span>$\mathbf{h}_t$</span>, and their link to the bike rental counts, <span>$\mathbf{y}_t$</span>.</p><h3 id="Equations-and-Priors"><a class="docs-heading-anchor" href="#Equations-and-Priors">Equations and Priors</a><a id="Equations-and-Priors-1"></a><a class="docs-heading-anchor-permalink" href="#Equations-and-Priors" title="Permalink"></a></h3><ol><li><p><strong>Feature Dynamics with Prior</strong>:</p><ul><li>Prior: <span>$\mathbf{a} \sim \mathcal{N}(\mathbf{0}, \mathbf{I})$</span></li><li>Dynamics: <span>$\mathbf{h}_t \sim \mathcal{N}(\mathbf{A h}_{t-1}, \mathbf{Q})$</span></li><li><p class="math-container">\[\mathbf{A}\]</p>is the transition matrix, reshaped from the prior vector <span>$\mathbf{a}$</span>, and <span>$\mathbf{Q}$</span> represents process noise.</li></ul></li><li><p><strong>Noisy Observations</strong>:</p><ul><li><p class="math-container">\[\mathbf{x}_t \sim \mathcal{N}(\mathbf{h}_t, \mathbf{P})\]</p></li><li>Represents the observed noisy state of the features.</li></ul></li><li><p><strong>Count Prediction with Prior</strong>:</p><ul><li>Prior: <span>$\boldsymbol{\theta} \sim \mathcal{N}(\mathbf{0}, \mathbf{I})$</span></li><li>Prediction: <span>$y_t \sim \mathcal{N}(\text{softplus}(\boldsymbol{\theta}^\top\mathbf{h}_t), \sigma^2)$</span></li><li>Models the bike rental count as influenced by a non-linear transformation of the hidden state.</li></ul></li></ol><h3 id="Interpretation"><a class="docs-heading-anchor" href="#Interpretation">Interpretation</a><a id="Interpretation-1"></a><a class="docs-heading-anchor-permalink" href="#Interpretation" title="Permalink"></a></h3><ul><li>This framework aims to simultaneously infer the transition matrix <span>$\mathbf{A}$</span> and the regression parameters <span>$\boldsymbol{\theta}$</span>, providing a comprehensive view of the feature space dynamics and the count prediction.</li><li>By employing Gaussian priors on both <span>$\mathbf{a}$</span> and <span>$\boldsymbol{\theta}$</span>, we incorporate beliefs about their distributions.</li><li>The inference process aims to discover these underlying dynamics, enabling predictions of both features <span>$\mathbf{x}_t$</span> and counts <span>$y_t$</span>.</li></ul><pre><code class="language-julia hljs"># # We augument the dataset with missing entries for 24 hours ahead
append!(X, repeat([missing], n_future))
append!(y, repeat([missing], n_future));</code></pre><pre><code class="language-julia hljs"># Function to perform the state transition in the model.
# It reshapes vector `a` into a matrix and multiplies it with vector `x` to simulate the transition.
function transition(a, x)
    nm, n = length(a), length(x)
    m = nm √∑ n  # Calculate the number of rows for reshaping &#39;a&#39; into a matrix
    A = reshape(a, (m, n))  
    return A * x
end</code></pre><pre><code class="nohighlight hljs">transition (generic function with 1 method)</code></pre><pre><code class="language-julia hljs"># The dotsoftplus function combines a dot product and softplus transformation.
# While useful for ensuring positivity, it may not be the optimal choice for all scenarios,
# especially if the data suggests other forms of relationships or distributions.
import StatsFuns: softplus
dotsoftplus(a, x) = softplus(dot(a, x))</code></pre><pre><code class="nohighlight hljs">dotsoftplus (generic function with 1 method)</code></pre><pre><code class="language-julia hljs"># model definction
@model function bicycle_ssm(x, y, h0, Œ∏0, a0, Q, s)

    a ~ a0
    Œ∏ ~ Œ∏0
    h_prior ~ h0

    h_prev = h_prior
    for i in eachindex(y)
        
        h[i] ~ MvNormal(Œº=transition(a, h_prev), Œ£=Q)
        x[i] ~ MvNormal(Œº=h[i], Œ£=diageye(state_dim))
        y[i] ~ Normal(Œº=dotsoftplus(Œ∏, h[i]), œÉ¬≤=s)
        h_prev = h[i]
    end

end</code></pre><pre><code class="language-julia hljs"># In this example, we opt for a basic Linearization approach for the transition and dotsoftplus functions.
# However, alternative methods like Unscented or CVI approximations can also be considered.
bicycle_ssm_meta = @meta begin 
    transition() -&gt; Linearization()
    dotsoftplus() -&gt; Linearization()
end</code></pre><pre><code class="nohighlight hljs">Meta: 
  transition() -&gt; ReactiveMP.Linearization()
  dotsoftplus() -&gt; ReactiveMP.Linearization()</code></pre><pre><code class="language-julia hljs"># prior_h: Based on first observation, assuming initial state is similar with equal variance.
prior_h = MvNormalMeanCovariance(X[1], diageye(state_dim))
# prior_Œ∏, prior_a: No initial bias, parameters independent with equal uncertainty.
prior_Œ∏ = MvNormalMeanCovariance(zeros(state_dim), diageye(state_dim))
prior_a = MvNormalMeanCovariance(zeros(state_dim^2), diageye(state_dim^2));</code></pre><p>Note that, in contrast with other examples, we wrap the data <code>y</code> in an <code>UnfactorizedData</code> struct. This is to indicate to the inference engine that we want to infer a joint posterior distribution over the missing values in <code>y</code> and the latent variables. More information on this can be found in the <a href="https://docs.rxinfer.ml">documentation</a> on variational constraints.</p><pre><code class="language-julia hljs"># the deterministic relationsships (transition) and (dotsoftplus) will induce loops in the graph representation of our model, this necessiates the initialization of the messages
imessages = @initialization begin
    Œº(h) = prior_h
    Œº(a) = prior_a
    Œº(Œ∏) = prior_Œ∏
end
# Assumptions about the model parameters:
# Q: Process noise based on observed features&#39; variance, assuming process variability reflects observed features variability.
# s: Observation noise based on observed data variance, directly estimating variance in the data, important for predictions
bicycle_model = bicycle_ssm(h0=prior_h, Œ∏0=prior_Œ∏, a0=prior_a, Q=var(filter(!ismissing, X)).*diageye(state_dim), s=var(filter(!ismissing, y)))

result = infer(
    model = bicycle_model,
    data  = (x=X, y=UnfactorizedData(y)), 
    options = (limit_stack_depth = 500, ), 
    returnvars = KeepLast(),
    predictvars = KeepLast(),
    initialization = imessages,
    meta = bicycle_ssm_meta,
    iterations = 20,
    showprogress=true,
)</code></pre><pre><code class="nohighlight hljs">Inference results:
  Posteriors       | available for (a, h, h_prior, Œ∏)
  Predictions      | available for (y, x)</code></pre><pre><code class="language-julia hljs"># For a sake of this example, we extract only predictions
mean_y, cov_y = mean.(result.predictions[:y]), cov.(result.predictions[:y])
mean_x, cov_x = mean.(result.predictions[:x]), var.(result.predictions[:x])

mean_x1, cov_x1 = getindex.(mean_x, 1), getindex.(cov_x, 1)
mean_x2, cov_x2 = getindex.(mean_x, 2), getindex.(cov_x, 2)
mean_x3, cov_x3 = getindex.(mean_x, 3), getindex.(cov_x, 3)
mean_x4, cov_x4 = getindex.(mean_x, 4), getindex.(cov_x, 4);</code></pre><pre><code class="language-julia hljs">slice = (300, length(y))
data = df[:, &quot;count&quot;][length(y)-n_future:length(y)]

p = scatter(y, 
            color=:darkblue, 
            markerstrokewidth=0,
            label=&quot;Observed Count&quot;, 
            alpha=0.6)

# Plotting the mean prediction with variance ribbon
plot!(mean_y, ribbon=sqrt.(cov_y), 
      color=:orange, 
      fillalpha=0.3,
      label=&quot;Predicted Mean ¬± Std Dev&quot;)

# Adding a vertical line to indicate the start of the future prediction
vline!([length(y)-n_future], 
       label=&quot;Prediction Start&quot;, 
       linestyle=:dash, 
       linecolor=:green)

# Future (unobserved) data
plot!(length(y)-n_future:length(y), data, label=&quot;Future Count&quot;)

# Adjusting the limits
xlims!(slice)

# Enhancing the plot with titles and labels
title!(&quot;Bike Rental Demand Prediction&quot;)
xlabel!(&quot;Time&quot;)
ylabel!(&quot;Bike Count&quot;)

# Adjust the legend
legend=:topright

# Show the final plot
display(p)</code></pre><p><img src="Predicting Bike Rental Demand_16_1.png" alt/></p><pre><code class="language-julia hljs">using Plots

# Define a color palette
palette = cgrad(:viridis)

# Plot the hidden states with observations
p1 = plot(mean_x1, ribbon=sqrt.(cov_x1), color=palette[1], label=&quot;Hidden State 1&quot;, legend=:topleft)
plot!(df[!, :temp], color=:grey, label=&quot;Temperature&quot;)
vline!([length(y)-n_future], linestyle=:dash, color=:red, label=&quot;Prediction Start&quot;)
xlabel!(&quot;Time&quot;)
ylabel!(&quot;Value&quot;)
title!(&quot;Temperature vs Hidden State 1&quot;)

p2 = plot(mean_x2, ribbon=sqrt.(cov_x2), color=palette[2], label=&quot;Hidden State 2&quot;, legend=:topleft)
plot!(df[!, :atemp], color=:grey, label=&quot;Feels-Like Temp&quot;)
vline!([length(y)-n_future], linestyle=:dash, color=:red, label=&quot;&quot;)
xlabel!(&quot;Time&quot;)
ylabel!(&quot;Value&quot;)
title!(&quot;Feels-Like Temp vs Hidden State 2&quot;)

p3 = plot(mean_x3, ribbon=sqrt.(cov_x3), color=palette[3], label=&quot;Hidden State 3&quot;, legend=:topleft)
plot!(df[!, :humidity], color=:grey, label=&quot;Humidity&quot;)
vline!([length(y)-n_future], linestyle=:dash, color=:red, label=&quot;Prediction Start&quot;)
xlabel!(&quot;Time&quot;)
ylabel!(&quot;Value&quot;)
title!(&quot;Humidity vs Hidden State 3&quot;)

p4 = plot(mean_x4, ribbon=sqrt.(cov_x4), color=palette[4], label=&quot;Hidden State 4&quot;, legend=:topleft)
plot!(df[!, :windspeed], color=:grey, label=&quot;Windspeed&quot;)
vline!([length(y)-n_future], linestyle=:dash, color=:red, label=&quot;Prediction Start&quot;)
xlabel!(&quot;Time&quot;)
ylabel!(&quot;Value&quot;)
title!(&quot;Windspeed vs Hidden State 4&quot;)

for p in [p1, p2, p3, p4]
    xlims!(p, first(slice), last(slice))
end

plot(p1, p2, p3, p4, layout=(2, 2), size=(800, 400))</code></pre><p><img src="Predicting Bike Rental Demand_17_1.png" alt/></p><h2 id="Improving-the-model"><a class="docs-heading-anchor" href="#Improving-the-model">Improving the model</a><a id="Improving-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Improving-the-model" title="Permalink"></a></h2><p>While our current model&#39;s predictions may not closely match real-world data, it&#39;s important to recognize that certain assumptions and simplifications were made that might have affected the results. The model is essentially a theoretical framework, highlighting the ability to simultaneously deduce states, parameters, and predictions, with an emphasis on the analysis&#39;s predictive aspect.</p><p>To enhance the model and refine its predictions, we can employ variational message passing. This method enables us to eliminate loops within the model by substituting initial messages with initial marginal distributions. This is achieved by utilizing <code>ContinuousTransition</code> (also referred to as <code>CTransition</code>) and <code>SoftDot</code> (aka <code>softdot</code>) nodes. These nodes facilitate the variational approximation of the transition matrix and the dot product, respectively.</p><pre><code class="language-julia hljs">transformation = a -&gt; reshape(a, state_dim, state_dim)</code></pre><pre><code class="nohighlight hljs">#31 (generic function with 1 method)</code></pre><pre><code class="language-julia hljs"># model definction
@model function bicycle_ssm_advanced(x, y, h0, Œ∏0, a0, P0, Œ≥0)

    a ~ a0
    Œ∏ ~ Œ∏0
    h_prior ~ h0
    P ~ P0
    Œ≥ ~ Œ≥0

    h_prev = h_prior
    for i in eachindex(y)
        
        h[i] ~ CTransition(h_prev, a, P)
        x[i]  ~ MvNormal(Œº=h[i], Œõ=diageye(state_dim))
        _y[i] ~ softdot(Œ∏, h[i], Œ≥)
        y[i] ~ Normal(Œº=softplus(_y[i]), Œ≥=1e4)
        h_prev = h[i]
    end

end</code></pre><pre><code class="language-julia hljs">bicycle_ssm_advanced_meta = @meta begin 
    softplus() -&gt; Linearization()
    CTransition() -&gt; CTMeta(transformation)
end</code></pre><pre><code class="nohighlight hljs">Meta: 
  softplus() -&gt; ReactiveMP.Linearization()
  ReactiveMP.ContinuousTransition() -&gt; ReactiveMP.ContinuousTransitionMeta{
Main.anonymous.var&quot;#31#32&quot;}(Main.anonymous.var&quot;#31#32&quot;())</code></pre><pre><code class="language-julia hljs">bicycle_ssm_advanced_constraints = @constraints begin
    q(h_prior, h, a, P, Œ≥, _y, y, Œ∏) = q(h_prior, h)q(a)q(P)q(Œ≥)q(_y, y)q(Œ∏)
end</code></pre><pre><code class="nohighlight hljs">Constraints: 
  q(h_prior, h, a, P, Œ≥, _y, y, Œ∏) = q(h_prior, h)q(a)q(P)q(Œ≥)q(_y, y)q(Œ∏)</code></pre><pre><code class="language-julia hljs">prior_P = ExponentialFamily.WishartFast(state_dim+2, inv.(var(filter(!ismissing, X))) .* diageye(state_dim))
prior_a = MvNormalMeanPrecision(ones(state_dim^2), diageye(state_dim^2));

prior_Œ≥ = GammaShapeRate(1.0, var(filter(!ismissing, y)))
prior_h = MvNormalMeanPrecision(X[1], diageye(state_dim))
prior_Œ∏ = MvNormalMeanPrecision(ones(state_dim), diageye(state_dim))

imarginals = @initialization begin 
    q(h) = prior_h
    q(a) = prior_a
    q(P) = prior_P
    q(Œ≥) = prior_Œ≥
    q(Œ∏) = prior_Œ∏
end

bicycle_model_advanced = bicycle_ssm_advanced(h0=prior_h, Œ∏0=prior_Œ∏, a0=prior_a, P0=prior_P, Œ≥0=prior_Œ≥)

result_advanced = infer(
    model = bicycle_model_advanced,
    data  = (x=X, y=y), 
    options = (limit_stack_depth = 500, ), 
    returnvars = KeepLast(),
    predictvars = KeepLast(),
    initialization = imarginals,
    constraints = bicycle_ssm_advanced_constraints,
    meta = bicycle_ssm_advanced_meta,
    iterations = 10,
    showprogress=true,
)</code></pre><pre><code class="nohighlight hljs">Inference results:
  Posteriors       | available for (a, P, _y, Œ≥, h, h_prior, Œ∏)
  Predictions      | available for (y, x)</code></pre><pre><code class="language-julia hljs"># For a sake of this example, we extract only predictions
mean_y, cov_y = mean.(result_advanced.predictions[:y]), cov.(result_advanced.predictions[:y])</code></pre><pre><code class="nohighlight hljs">([16.000001019201765, 39.9999999771452, 32.00000029690829, 13.0000012305664
04, 1.000001735201384, 1.0000019345942357, 2.0000015515352927, 3.0000014149
59412, 8.000001680637501, 14.000001845050349  ‚Ä¶  30.828422951410317, 30.492
908849047463, 30.18361227547192, 29.894986174196585, 29.622442386947597, 29
.36222177841353, 29.1112910142145, 28.867262253805237, 28.628327961907303, 
28.393168163897517], [0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.000
1, 0.0001, 0.0001, 0.0001  ‚Ä¶  0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.000
1, 0.0001, 0.0001, 0.0001, 0.0001])</code></pre><pre><code class="language-julia hljs">slice = (300, length(y))
data = df[:, &quot;count&quot;][length(y)-n_future:length(y)]

pa = scatter(y, 
            color=:darkblue, 
            markerstrokewidth=0,
            label=&quot;Observed Count&quot;, 
            alpha=0.6)

# Plotting the mean prediction with variance ribbon
plot!(mean_y, ribbon=sqrt.(cov_y), 
      color=:orange, 
      fillalpha=0.3,
      label=&quot;Predicted Mean ¬± Std Dev&quot;)

# Adding a vertical line to indicate the start of the future prediction
vline!([length(y)-n_future], 
       label=&quot;Prediction Start&quot;, 
       linestyle=:dash, 
       linecolor=:green)

# Future (unobserved) data
plot!(length(y)-n_future:length(y), data, label=&quot;Future Count&quot;)

# Adjusting the limits
xlims!(slice)

# Enhancing the plot with titles and labels
title!(&quot;Advanced model&quot;)
xlabel!(&quot;Time&quot;)
ylabel!(&quot;Bike Count&quot;)

# Adjust the legend
legend=:topright

# Show the final plot
plot(pa, p, size=(800, 400))</code></pre><p><img src="Predicting Bike Rental Demand_24_1.png" alt/></p><hr/><div class="admonition is-info"><header class="admonition-header">Contributing</header><div class="admonition-body"><p>This example was automatically generated from a Jupyter notebook in the <a href="https://github.com/ReactiveBayes/RxInferExamples.jl">RxInferExamples.jl</a> repository.</p><p>We welcome and encourage contributions! You can help by:</p><ul><li>Improving this example</li><li>Creating new examples </li><li>Reporting issues or bugs</li><li>Suggesting enhancements</li></ul><p>Visit our <a href="https://github.com/ReactiveBayes/RxInferExamples.jl">GitHub repository</a> to get started. Together we can make <a href="https://github.com/ReactiveBayes/RxInfer.jl">RxInfer.jl</a> even better! üí™</p></div></div><hr/><div class="admonition is-compat"><header class="admonition-header">Environment</header><div class="admonition-body"><p>This example was executed in a clean, isolated environment. Below are the exact package versions used:</p><p>For reproducibility:</p><ul><li>Use the same package versions when running locally</li><li>Report any issues with package compatibility</li></ul></div></div><pre><code class="nohighlight hljs">Status `~/work/RxInferExamples.jl/RxInferExamples.jl/docs/src/categories/basic_examples/predicting_bike_rental_demand/Project.toml`
  [336ed68f] CSV v0.10.15
  [a93c6f00] DataFrames v1.7.0
  [91a5bcdd] Plots v1.40.9
  [86711068] RxInfer v4.2.0
  [4c63d2b9] StatsFuns v1.3.2
</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../pomdp_control/">¬´ Pomdp Control</a><a class="docs-footer-nextpage" href="../../advanced_examples/active_inference_mountain_car/">Active Inference Mountain Car ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Created in <a href="https://biaslab.github.io/">BIASlab</a>, maintained by <a href="https://github.com/ReactiveBayes">ReactiveBayes</a>, powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Friday 7 March 2025 13:50">Friday 7 March 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
